#!/bin/bash

failed()
{
  sleep 2 # Wait for the kernel to stop whining
  echo "Hrm, that didn't work.  Calling for help."
  sudo ipmitool chassis identify force
  echo "Interfaces config failed: ${1}"
  while [ 1 ]; do sleep 10; done
  exit 1;
}

cat > /target/etc/udev/rules.d/70-persistent-net.rules <<EOF
SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="<%= $db_node_info->{'boot_mac'} %>", ATTR{dev_id}=="0x0", ATTR{type}=="1", KERNEL=="eth*", NAME="eth0"
EOF

cat > /target/etc/network/interfaces <<EOF
# Generated by nephology

# The loopback network interface
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
  address <%= $db_node_info->{'primary_ip'} %>
  netmask 255.255.255.0
  gateway 192.168.57.1

# The Storage Front End Bond
auto bond0
iface bond0 inet6 static
  address 2607:f298:4:2243::<%= $db_node_info->{'asset_tag'} %>
  netmask 64
  slaves eth4 eth5
  bond_mode 802.3ad
  bond_miimon 100
  bond_downdelay 200
  bond_updelay 200

# The OSD Back End Bond
auto bond1
iface bond1 inet6 static
  address 2607:f298:4:3243::<%= $db_node_info->{'asset_tag'} %>
  netmask 64
  slaves eth2 eth3
  bond_mode 802.3ad
  bond_miimon 100
  bond_downdelay 200
  bond_updelay 200
EOF